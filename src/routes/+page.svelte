<script lang="ts">
	import { onMount } from 'svelte';
	import FeedComponent from '../components/Feed.svelte';
	import Header from '../components/Header.svelte';
	import { feeds, type Feed } from '../feeds';
	import { Cluster, constructAutoFeed } from '../nlp';
	import { fetchRssFeed, type Item } from '../rss';

	let itemsByFeed: { [feed: string]: (Item | Cluster)[] } = {};

	const autoTopStoriesFeed: Feed = {
		source: 'feeder.news',
		section: 'âœ¨ Auto Top Stories',
		feed: 'feeder.news'
	};

	async function fetchFeeds() {
		const promises = feeds.map(async (feed) => {
			const items = await fetchRssFeed(feed);
			itemsByFeed[feed.feed] = items;
			updateAutoFeed();
		});

		return Promise.all(promises);
	}

	function updateAutoFeed() {
		itemsByFeed[autoTopStoriesFeed.feed] = constructAutoFeed(
			feeds,
			itemsByFeed as { [feed: string]: Item[] }
		);
	}

	onMount(async () => {
		await fetchFeeds();
	});
</script>

<Header />

<div class="flex overflow-x-auto">
	{#each feeds as feed}
		<FeedComponent {feed} items={itemsByFeed[feed.feed] ?? []} />
	{/each}
	<FeedComponent
		feed={autoTopStoriesFeed}
		items={itemsByFeed[autoTopStoriesFeed.feed] ?? []}
		autogenerated={true}
	/>
</div>
